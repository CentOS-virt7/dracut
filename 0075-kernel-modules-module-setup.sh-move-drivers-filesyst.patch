From aec9f902f009bf7b13fe2ca679f95439c035c32a Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 27 Jul 2012 16:03:42 +0200
Subject: [PATCH] kernel-modules/module-setup.sh: move "$drivers"
 "$filesystems" and "$add_drivers" to dracut.sh

---
 dracut.sh                                  | 16 ++++++++++++++--
 modules.d/90kernel-modules/module-setup.sh | 11 -----------
 2 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/dracut.sh b/dracut.sh
index eee829e..4be4306 100755
--- a/dracut.sh
+++ b/dracut.sh
@@ -780,9 +780,9 @@ if ! [[ -d "$systemdutildir" ]]; then
 fi
 [[ -d "$systemdsystemunitdir" ]] || systemdsystemunitdir=${systemdutildir}/system
 
-export initdir dracutbasedir dracutmodules drivers \
+export initdir dracutbasedir dracutmodules \
     fw_dir drivers_dir debug no_kernel kernel_only \
-    add_drivers omit_drivers mdadmconf lvmconf filesystems \
+    omit_drivers mdadmconf lvmconf \
     use_fstab fstab_lines libdirs fscks nofscks ro_mnt \
     stdloglvl sysloglvl fileloglvl kmsgloglvl logfile \
     debug host_fs_types host_devs sshkey add_fstab \
@@ -898,6 +898,18 @@ dinfo "*** Including modules done ***"
 
 ## final stuff that has to happen
 if [[ $no_kernel != yes ]]; then
+
+    if [[ $drivers ]]; then
+        hostonly='' instmods $drivers
+    fi
+
+    if [[ $add_drivers ]]; then
+        hostonly='' instmods -c $add_drivers
+    fi
+    if [[ $filesystems ]]; then
+        hostonly='' instmods -c $filesystems
+    fi
+
     dinfo "*** Installing kernel module dependencies and firmware ***"
     dracut_kernel_post
     dinfo "*** Installing kernel module dependencies and firmware done ***"
diff --git a/modules.d/90kernel-modules/module-setup.sh b/modules.d/90kernel-modules/module-setup.sh
index 5018dc1..47e2f0d 100755
--- a/modules.d/90kernel-modules/module-setup.sh
+++ b/modules.d/90kernel-modules/module-setup.sh
@@ -61,17 +61,6 @@ installkernel() {
             }
             for_each_host_dev_fs inst_fs
         fi
-    else
-        hostonly='' instmods $drivers
-    fi
-
-    if [[ $add_drivers ]]; then
-        hostonly='' instmods -c $add_drivers || return 1
-    fi
-    if [[ $filesystems ]]; then
-        hostonly='' instmods -c $filesystems || return 1
-    fi
-
 }
 
 install() {

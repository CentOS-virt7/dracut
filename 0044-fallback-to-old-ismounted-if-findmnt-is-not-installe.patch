From 4211605000dcb2fef66e90b1c8739f2d02ee1ebc Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Thu, 20 Sep 2012 10:36:13 +0200
Subject: [PATCH] fallback to old ismounted, if findmnt is not installed

---
 modules.d/30convertfs/convertfs.sh | 28 +++++++++++++++++++++++++---
 modules.d/99base/dracut-lib.sh     | 29 ++++++++++++++++++++++++++---
 modules.d/99base/module-setup.sh   |  5 +++--
 3 files changed, 54 insertions(+), 8 deletions(-)

diff --git a/modules.d/30convertfs/convertfs.sh b/modules.d/30convertfs/convertfs.sh
index d1d25aa..137664a 100755
--- a/modules.d/30convertfs/convertfs.sh
+++ b/modules.d/30convertfs/convertfs.sh
@@ -73,13 +73,35 @@ if [[ ! -e "$testfile" ]]; then
 fi
 rm -f "$testfile"
 
-ismounted() {
-    while read a m a; do
-        [[ "$m" = "$1" ]] && return 0
+find_mount() {
+    local dev mnt etc wanted_dev
+    wanted_dev="$(readlink -e -q $1)"
+    while read dev mnt etc; do
+        [ "$dev" = "$wanted_dev" ] && echo "$dev" && return 0
     done < /proc/mounts
     return 1
 }
 
+# usage: ismounted <mountpoint>
+# usage: ismounted /dev/<device>
+if command -v findmnt >/dev/null; then
+    ismounted() {
+        findmnt "$1" > /dev/null 2>&1
+    }
+else
+    ismounted() {
+        if [ -b "$1" ]; then
+            find_mount "$1" > /dev/null && return 0
+            return 1
+        fi
+
+        while read a m a; do
+            [ "$m" = "$1" ] && return 0
+        done < /proc/mounts
+        return 1
+    }
+fi
+
 # clean up after ourselves no matter how we die.
 cleanup() {
     echo "Something failed. Move back to the original state"
diff --git a/modules.d/99base/dracut-lib.sh b/modules.d/99base/dracut-lib.sh
index 6fd4e0a..1d90010 100755
--- a/modules.d/99base/dracut-lib.sh
+++ b/modules.d/99base/dracut-lib.sh
@@ -452,11 +452,34 @@ udevproperty() {
     fi
 }
 
+find_mount() {
+    local dev mnt etc wanted_dev
+    wanted_dev="$(readlink -e -q $1)"
+    while read dev mnt etc; do
+        [ "$dev" = "$wanted_dev" ] && echo "$dev" && return 0
+    done < /proc/mounts
+    return 1
+}
+
 # usage: ismounted <mountpoint>
 # usage: ismounted /dev/<device>
-ismounted() {
-    findmnt "$1" > /dev/null
-}
+if command -v findmnt >/dev/null; then
+    ismounted() {
+        findmnt "$1" > /dev/null 2>&1
+    }
+else
+    ismounted() {
+        if [ -b "$1" ]; then
+            find_mount "$1" > /dev/null && return 0
+            return 1
+        fi
+
+        while read a m a; do
+            [ "$m" = "$1" ] && return 0
+        done < /proc/mounts
+        return 1
+    }
+fi
 
 wait_for_if_up() {
     local cnt=0
diff --git a/modules.d/99base/module-setup.sh b/modules.d/99base/module-setup.sh
index 6cc4ad2..2bcb6a1 100755
--- a/modules.d/99base/module-setup.sh
+++ b/modules.d/99base/module-setup.sh
@@ -13,11 +13,12 @@ depends() {
 
 install() {
     local _d
-    dracut_install mount mknod mkdir pidof sleep chroot findmnt\
+    dracut_install mount mknod mkdir pidof sleep chroot \
         sed ls flock cp mv dmesg rm ln rmmod mkfifo umount readlink setsid
     inst $(command -v modprobe) /sbin/modprobe
 
-    dracut_install -o less
+    dracut_install -o findmnt less
+
     if [ ! -e "${initdir}/bin/sh" ]; then
         dracut_install bash
         (ln -s bash "${initdir}/bin/sh" || :)

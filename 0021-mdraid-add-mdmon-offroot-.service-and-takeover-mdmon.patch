From c9f1efbceef35615a395fd8a979205f6b75eac43 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 18 Jan 2013 11:01:43 +0100
Subject: [PATCH] mdraid: add mdmon-offroot@.service and takeover mdmon in
 shutdown

---
 modules.d/90mdraid/mdmon-pre-shutdown.sh | 16 ++++++++++++++++
 modules.d/90mdraid/module-setup.sh       |  5 ++++-
 2 files changed, 20 insertions(+), 1 deletion(-)
 create mode 100755 modules.d/90mdraid/mdmon-pre-shutdown.sh

diff --git a/modules.d/90mdraid/mdmon-pre-shutdown.sh b/modules.d/90mdraid/mdmon-pre-shutdown.sh
new file mode 100755
index 0000000..a6cd605
--- /dev/null
+++ b/modules.d/90mdraid/mdmon-pre-shutdown.sh
@@ -0,0 +1,16 @@
+#!/bin/sh
+# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
+# ex: ts=8 sw=4 sts=4 et filetype=sh
+_do_mdmon_takeover() {
+    local ret
+    mdmon --takeover --all
+    ret=$?
+    [ $ret -eq 0 ] && info "Taking over mdmon processes."
+    return $ret
+}
+
+if command -v mdmon >/dev/null; then
+    _do_mdmon_takeover $1
+else
+    :
+fi
diff --git a/modules.d/90mdraid/module-setup.sh b/modules.d/90mdraid/module-setup.sh
index 3c3f057..3b5620c 100755
--- a/modules.d/90mdraid/module-setup.sh
+++ b/modules.d/90mdraid/module-setup.sh
@@ -88,5 +88,8 @@ install() {
     inst_hook shutdown 30 "$moddir/md-shutdown.sh"
     inst_script "$moddir/mdraid-cleanup.sh" /sbin/mdraid-cleanup
     inst_script "$moddir/mdraid_start.sh" /sbin/mdraid_start
+    if [ -e /lib/systemd/system/mdmon-offroot@.service ]; then
+        inst_simple /lib/systemd/system/mdmon-offroot@.service
+    fi
+    inst_hook pre-shutdown 30 "$moddir/mdmon-pre-shutdown.sh"
 }
-

From 54703a719f49b3c4aafb60d49b265e2cde9bb16f Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 20 Jul 2011 14:10:30 +0200
Subject: [PATCH] add  TEST-15-BTRFSRAID

---
 test/TEST-15-BTRFSRAID/99-idesymlinks.rules |    8 +++
 test/TEST-15-BTRFSRAID/Makefile             |   10 +++
 test/TEST-15-BTRFSRAID/create-root.sh       |   22 +++++++
 test/TEST-15-BTRFSRAID/hard-off.sh          |    3 +
 test/TEST-15-BTRFSRAID/test-init            |   11 ++++
 test/TEST-15-BTRFSRAID/test.sh              |   82 +++++++++++++++++++++++++++
 6 files changed, 136 insertions(+), 0 deletions(-)
 create mode 100644 test/TEST-15-BTRFSRAID/99-idesymlinks.rules
 create mode 100644 test/TEST-15-BTRFSRAID/Makefile
 create mode 100755 test/TEST-15-BTRFSRAID/create-root.sh
 create mode 100755 test/TEST-15-BTRFSRAID/hard-off.sh
 create mode 100755 test/TEST-15-BTRFSRAID/test-init
 create mode 100755 test/TEST-15-BTRFSRAID/test.sh

diff --git a/test/TEST-15-BTRFSRAID/99-idesymlinks.rules b/test/TEST-15-BTRFSRAID/99-idesymlinks.rules
new file mode 100644
index 0000000..d557790
--- /dev/null
+++ b/test/TEST-15-BTRFSRAID/99-idesymlinks.rules
@@ -0,0 +1,8 @@
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="disk", KERNEL=="hda", SYMLINK+="sda"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="partition", KERNEL=="hda*", SYMLINK+="sda$env{MINOR}"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="disk", KERNEL=="hdb", SYMLINK+="sdb"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="partition", KERNEL=="hdb*", SYMLINK+="sdb$env{MINOR}"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="disk", KERNEL=="hdc", SYMLINK+="sdc"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="partition", KERNEL=="hdc*", SYMLINK+="sdc$env{MINOR}"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="disk", KERNEL=="hdd", SYMLINK+="sdd"
+ACTION=="add|change", SUBSYSTEM=="block", ENV{DEVTYPE}=="partition", KERNEL=="hdd*", SYMLINK+="sdd$env{MINOR}"
diff --git a/test/TEST-15-BTRFSRAID/Makefile b/test/TEST-15-BTRFSRAID/Makefile
new file mode 100644
index 0000000..bc0ddb6
--- /dev/null
+++ b/test/TEST-15-BTRFSRAID/Makefile
@@ -0,0 +1,10 @@
+all:
+	@make -s --no-print-directory -C ../.. all
+	@basedir=../.. testdir=../ ./test.sh --all
+setup:
+	@make --no-print-directory -C ../.. all
+	@basedir=../.. testdir=../ ./test.sh --setup
+clean:
+	@basedir=../.. testdir=../ ./test.sh --clean
+run:
+	@basedir=../.. testdir=../ ./test.sh --run
diff --git a/test/TEST-15-BTRFSRAID/create-root.sh b/test/TEST-15-BTRFSRAID/create-root.sh
new file mode 100755
index 0000000..60dd319
--- /dev/null
+++ b/test/TEST-15-BTRFSRAID/create-root.sh
@@ -0,0 +1,22 @@
+#!/bin/sh
+# don't let udev and this script step on eachother's toes
+for x in 64-lvm.rules 70-mdadm.rules 99-mount-rules; do
+    > "/etc/udev/rules.d/$x"
+done
+udevadm control --reload-rules
+# save a partition at the beginning for future flagging purposes
+sfdisk -C 524288 -H 2 -S 32 -L /dev/sda <<EOF
+,16
+,10240
+,10240
+,10240
+EOF
+mkfs.btrfs -mraid10 -L root /dev/sda2 /dev/sda3 /dev/sda4
+btrfs device scan
+set -e
+mkdir -p /sysroot 
+mount /dev/sda4 /sysroot 
+cp -a -t /sysroot /source/* 
+umount /sysroot 
+echo "dracut-root-block-created" >/dev/sda1
+poweroff -f
diff --git a/test/TEST-15-BTRFSRAID/hard-off.sh b/test/TEST-15-BTRFSRAID/hard-off.sh
new file mode 100755
index 0000000..12c3d5a
--- /dev/null
+++ b/test/TEST-15-BTRFSRAID/hard-off.sh
@@ -0,0 +1,3 @@
+#!/bin/sh
+getarg rd.shell || poweroff -f
+getarg failme && poweroff -f
diff --git a/test/TEST-15-BTRFSRAID/test-init b/test/TEST-15-BTRFSRAID/test-init
new file mode 100755
index 0000000..8f7cdf3
--- /dev/null
+++ b/test/TEST-15-BTRFSRAID/test-init
@@ -0,0 +1,11 @@
+#!/bin/sh
+export PATH=/sbin:/bin:/usr/sbin:/usr/bin
+exec >/dev/console 2>&1
+echo "dracut-root-block-success" >/dev/sda1
+export TERM=linux
+export PS1='initramfs-test:\w\$ '
+[ -f /etc/fstab ] || ln -s /proc/mounts /etc/fstab
+stty sane
+echo "made it to the rootfs! Powering down."
+mount -n -o remount,ro /
+poweroff -f
diff --git a/test/TEST-15-BTRFSRAID/test.sh b/test/TEST-15-BTRFSRAID/test.sh
new file mode 100755
index 0000000..96ecd2e
--- /dev/null
+++ b/test/TEST-15-BTRFSRAID/test.sh
@@ -0,0 +1,82 @@
+#!/bin/bash
+TEST_DESCRIPTION="root filesystem on multiple device btrfs"
+
+KVERSION=${KVERSION-$(uname -r)}
+
+# Uncomment this to debug failures
+#DEBUGFAIL="rd.shell"
+DISKIMAGE=/var/tmp/TEST-15-BTRFSRAID-root.img
+test_run() {
+    $testdir/run-qemu -hda $DISKIMAGE -m 256M -nographic \
+	-net none -kernel /boot/vmlinuz-$KVERSION \
+	-append "root=LABEL=root rw quiet rd.retry=3 rd.info console=ttyS0,115200n81 selinux=0 rd.debug  $DEBUGFAIL" \
+	-initrd initramfs.testing
+    grep -m 1 -q dracut-root-block-success $DISKIMAGE || return 1
+}
+
+test_setup() {
+    # Create the blank file to use as a root filesystem
+    dd if=/dev/null of=$DISKIMAGE bs=1M seek=1024
+
+    kernel=$KVERSION
+    # Create what will eventually be our root filesystem onto an overlay
+    (
+	initdir=overlay/source
+	. $basedir/dracut-functions
+	dracut_install sh df free ls shutdown poweroff stty cat ps ln ip route \
+	    /lib/terminfo/l/linux mount dmesg ifconfig dhclient mkdir cp ping dhclient
+	inst "$basedir/modules.d/40network/dhclient-script" "/sbin/dhclient-script"
+	inst "$basedir/modules.d/40network/ifup" "/sbin/ifup"
+	dracut_install grep
+	inst ./test-init /sbin/init
+	find_binary plymouth >/dev/null && dracut_install plymouth
+	(cd "$initdir"; mkdir -p dev sys proc etc var/run tmp )
+	cp -a /etc/ld.so.conf* $initdir/etc
+	sudo ldconfig -r "$initdir"
+    )
+
+    # second, install the files needed to make the root filesystem
+    (
+	initdir=overlay
+	. $basedir/dracut-functions
+	dracut_install sfdisk mkfs.btrfs poweroff cp umount
+	inst_hook initqueue 01 ./create-root.sh
+	inst_simple ./99-idesymlinks.rules /etc/udev/rules.d/99-idesymlinks.rules
+    )
+
+    # create an initramfs that will create the target root filesystem.
+    # We do it this way so that we do not risk trashing the host mdraid
+    # devices, volume groups, encrypted partitions, etc.
+    $basedir/dracut -l -i overlay / \
+	-m "dash btrfs udev-rules base rootfs-block kernel-modules" \
+	-d "piix ide-gd_mod ata_piix btrfs sd_mod" \
+        --nomdadmconf \
+	-f initramfs.makeroot $KVERSION || return 1
+    rm -rf overlay
+    # Invoke KVM and/or QEMU to actually create the target filesystem.
+    $testdir/run-qemu -hda $DISKIMAGE -m 256M -nographic -net none \
+	-kernel "/boot/vmlinuz-$kernel" \
+	-append "root=LABEL=root rw quiet console=ttyS0,115200n81 selinux=0" \
+	-initrd initramfs.makeroot  || return 1
+    grep -m 1 -q dracut-root-block-created $DISKIMAGE || return 1
+    (
+	initdir=overlay
+	. $basedir/dracut-functions
+	dracut_install poweroff shutdown
+	inst_hook emergency 000 ./hard-off.sh
+	inst ./cryptroot-ask /sbin/cryptroot-ask
+	inst_simple ./99-idesymlinks.rules /etc/udev/rules.d/99-idesymlinks.rules
+    )
+    sudo $basedir/dracut -l -i overlay / \
+	-o "plymouth network" \
+	-a "debug" \
+	-d "piix ide-gd_mod ata_piix btrfs sd_mod" \
+	-f initramfs.testing $KVERSION || return 1
+}
+
+test_cleanup() {
+    rm -fr overlay mnt
+    rm -f $DISKIMAGE initramfs.makeroot initramfs.testing
+}
+
+. $testdir/test-functions

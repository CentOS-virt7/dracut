From 8a1a2f6ca4c9c82f45ed793ffc9902451a04bc41 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 18 Apr 2012 12:42:39 +0200
Subject: [PATCH] udevd moved to /lib/systemd/systemd-udevd

---
 dracut.conf.d/fedora.conf.example      |    1 +
 modules.d/95udev-rules/module-setup.sh |   10 +++++++++-
 modules.d/99base/init.sh               |    2 +-
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/dracut.conf.d/fedora.conf.example b/dracut.conf.d/fedora.conf.example
index 02a530e..617d967 100644
--- a/dracut.conf.d/fedora.conf.example
+++ b/dracut.conf.d/fedora.conf.example
@@ -8,3 +8,4 @@ omit_drivers+=" .*/fs/ocfs/.* "
 stdloglvl=3
 realinitpath="/usr/lib/systemd/systemd"
 install_items+=" vi /etc/virc ps grep cat rm "
+prefix="/"
diff --git a/modules.d/95udev-rules/module-setup.sh b/modules.d/95udev-rules/module-setup.sh
index b17232f..cc42eb7 100755
--- a/modules.d/95udev-rules/module-setup.sh
+++ b/modules.d/95udev-rules/module-setup.sh
@@ -8,12 +8,20 @@ install() {
     # ultimately, /lib/initramfs/rules.d or somesuch which includes links/copies
     # of the rules we want so that we just copy those in would be best
     dracut_install udevadm
-    [ -x /sbin/udevd ] && dracut_install udevd
+    if [ -x /sbin/udevd ]; then
+        dracut_install udevd
+        mkdir -p ${initdir}/lib/systemd
+        ln -s /sbin/udevd ${initdir}/lib/systemd/systemd-udevd
+    elif [ -x /lib/systemd/systemd-udevd ]; then
+        inst /lib/systemd/systemd-udevd
+    fi
 
     for i in /etc/udev/udev.conf /etc/group; do
         inst_simple $i
     done
+
     dracut_install basename
+
     inst_rules 50-udev-default.rules 60-persistent-storage.rules \
         61-persistent-storage-edd.rules 80-drivers.rules 95-udev-late.rules \
         60-pcmcia.rules
diff --git a/modules.d/99base/init.sh b/modules.d/99base/init.sh
index 2f87a20..0ea72e8 100755
--- a/modules.d/99base/init.sh
+++ b/modules.d/99base/init.sh
@@ -110,7 +110,7 @@ getarg 'rd.break=pre-udev' 'rdbreak=pre-udev' && emergency_shell -n pre-udev "Br
 source_hook pre-udev
 
 # start up udev and trigger cold plugs
-udevd --daemon --resolve-names=never
+/lib/systemd/systemd-udevd --daemon --resolve-names=never
 
 UDEV_LOG_PRIO_ARG=--log-priority
 UDEV_QUEUE_EMPTY="udevadm settle --timeout=0"

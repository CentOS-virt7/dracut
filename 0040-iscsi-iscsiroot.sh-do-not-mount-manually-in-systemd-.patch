From 0a5fd0dcec3f6fd49626fed0cac4e89cd1ad3453 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Thu, 14 Mar 2013 17:54:36 +0100
Subject: [PATCH] iscsi/iscsiroot.sh: do not mount manually in systemd mode

---
 modules.d/95iscsi/iscsiroot.sh    | 3 ++-
 modules.d/95iscsi/module-setup.sh | 4 +++-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/modules.d/95iscsi/iscsiroot.sh b/modules.d/95iscsi/iscsiroot.sh
index aa6c6ec..0c04219 100755
--- a/modules.d/95iscsi/iscsiroot.sh
+++ b/modules.d/95iscsi/iscsiroot.sh
@@ -145,7 +145,8 @@ handle_netroot()
         wait_for_dev /dev/root
 
         # install mount script
-        echo "iscsi_lun=$iscsi_lun . /bin/mount-lun.sh " > $hookdir/mount/01-$$-iscsi.sh
+        [ -z "$DRACUT_SYSTEMD" ] && \
+            echo "iscsi_lun=$iscsi_lun . /bin/mount-lun.sh " > $hookdir/mount/01-$$-iscsi.sh
     fi
 
     # force udevsettle to break
diff --git a/modules.d/95iscsi/module-setup.sh b/modules.d/95iscsi/module-setup.sh
index f06c783..1910a33 100755
--- a/modules.d/95iscsi/module-setup.sh
+++ b/modules.d/95iscsi/module-setup.sh
@@ -78,6 +78,8 @@ install() {
     inst_hook cmdline 90 "$moddir/parse-iscsiroot.sh"
     inst_hook cleanup 90 "$moddir/cleanup-iscsi.sh"
     inst "$moddir/iscsiroot.sh" "/sbin/iscsiroot"
-    inst "$moddir/mount-lun.sh" "/bin/mount-lun.sh"
+    if ! dracut_module_included "systemd"; then
+        inst "$moddir/mount-lun.sh" "/bin/mount-lun.sh"
+    fi
     dracut_need_initqueue
 }
